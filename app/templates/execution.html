{% extends "base.html" %}
{% import 'bootstrap/wtf.html' as wtf %}
{% import '_logView.html' as logView %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/log.css') }}">
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{url_for('static', filename='js/updateExecutionStatus.js')}}"></script>
{{ logView.logScripts() }}
<script>
function checkNewExecutions(){
    let current = $('#hiddenNextId').text();
    $.get("{{ url_for('main.nextExecutionId') }}")
        .done(function (response){
            if (response['NextId'].toString() !== current){
                location.reload();
            }
        }
    );
}
setInterval(checkNewExecutions, 5000)
</script>

{% if execution.status not in ['Finished', 'Cancelled', 'Errored'] %}
<script>
function update{{ execution.id }}(nanobar) {
    $.get("{{ url_for('main.json', executionId=execution.id) }}")
        .done(function (response) {
            if (response['Status'] === 'Finished'){
                updateOne($("#table_status{{ execution.id }}"), response['Status']);
                $(".{{ execution.id }}div").fadeTo(500, 0).slideUp(500, function(){ $(this).remove(); });
            } else {
                updateOne($("#status{{ execution.id }}"), response['Status']);
                updateOne($("#table_status{{ execution.id }}"), response['Status']);
                updatePerCent(nanobar, response['PerCent'], $('#percent{{ execution.id }}'));
                updateMessage($('#message{{ execution.id }}'), response['Message']);
                setTimeout(function() { update{{ execution.id }}(nanobar); }, 5000);
            }
        }
    );
}
</script>
<script>
div = $(
    "<span class='message' id='message{{ execution.id }}'></span>" +
    "<span class='progress'></span>" +
    "<span id='percent{{ execution.id }}' style='display: none;'></span>"
);
$('#progress{{ execution.id }}').append(div);
var nanobar = Nanobar({ target: div[1] });
update{{ execution.id }}(nanobar);
</script>
{% endif %}
{% endblock %}

{% macro accordionCard(accordion, card, logInfo) %}
{% set LogLevels = ['Debug', 'Info', 'Warning', 'Error', 'Critical'] %}
<div class="card">
    <div class="panel panel-info">
        {{ logView.logView(card, logInfo) }}
    </div>
</div>
{% endmacro %}

{% block app_content %}
<div style="text-align: center">
    <h2>Execution {{ execution.id }}</h2>
</div>
<p id="hiddenNextId" style="display: none">{{ executionId }}</p>
{% if execution.status not in ['Finished', 'Cancelled', 'Errored'] %}
<div class="{{ execution.id }}div alert alert-info" role="alert" style="width: 400px">
    <span>Execution {{ execution.id }}:</span>
    <span id="status{{ execution.id }}" style="font-weight: bold">{{ execution.status }}</span>
    </br>
    <span id="progress{{ execution.id }}"></span>
</div>
</br>
{% endif %}
<table class="table table-header">
    <thead class="thead-dark">
    <tr>
        <th>Status</th>
        <th>Start Time</th>
        <th>End Time</th>
        <th>Experiment</th>
        <th>Action</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td>
            {% if execution.status == 'Init' %}
            <span class="label label-default" id="table_status{{ execution.id }}">{{ execution.status }}</span>
            {% elif execution.status in ['PreRun', 'Run', 'PostRun'] %}
            <span class="label label-primary" id="table_status{{ execution.id }}">{{ execution.status }}</span>
            {% elif execution.status == 'Finished' %}
            <span class="label label-success">{{ execution.status }}</span>
            {% elif execution.status == 'Cancelled' %}
            <span class="label label-warning">{{ execution.status }}</span>
            {% elif execution.status == 'Errored' %}
            <span class="label label-danger">{{ execution.status }}</span>
            {% endif %}
        </td>
        </td>
        <td>
            {{ moment(execution.start_time).format('DD MMMM YYYY, h:mm:ss') }}
        </td>
        <td>
            {{ moment(execution.end_time).format('DD MMMM YYYY, h:mm:ss') }}
        </td>
        <td>
            {{ experiment.name }}
        </td>
        <td>
            {% if grafana_url == None or not execution.dashboard_url %}
            <a class="btn btn-primary btn-sm disabled" href="#" role="button">Results</a>
            {% else %}
            <a class="btn btn-blue btn-sm" href="{{ grafana_url }}{{ execution.dashboard_url }}" role="button"
               target="_blank">Results</a>
            {% endif %}
        </td>
    </tr>
    </tbody>
</table>
<hr>
</br>

{{ accordionCard('logAccordion', 'Pre-Run', preRun) }}
{{ accordionCard('logAccordion', 'Run', executor) }}
{{ accordionCard('logAccordion', 'Post-Run', postRun) }}

{% endblock %}