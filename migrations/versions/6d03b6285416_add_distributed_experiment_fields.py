"""Add distributed experiment fields

Revision ID: 6d03b6285416
Revises: 38a1ecff2c63
Create Date: 2020-10-20 12:48:19.545444

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.sql import text


# revision identifiers, used by Alembic.
revision = '6d03b6285416'
down_revision = '38a1ecff2c63'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    #op.add_column('experiment', sa.Column('remoteDescriptor_id', sa.Integer(), nullable=True))
    #op.add_column('experiment', sa.Column('remotePlatform', sa.String(length=128), nullable=True))
    #op.create_foreign_key(None, 'experiment', 'experiment', ['remoteDescriptor_id'], ['id'])
    # ### end Alembic commands ###

    # ALTER commands for sqlite
    op.get_bind().execute(text("""
    create table experiment_tmp(
        id INTEGER not null primary key,
        user_id INTEGER references user,
        name VARCHAR(64),
        type VARCHAR(32),
        automated BOOLEAN,
        test_cases VARCHAR,
        ues VARCHAR,
        slice VARCHAR(64),
        application VARCHAR(64),
        exclusive BOOLEAN,
        parameters VARCHAR,
        scenario VARCHAR(64),
        reservation_time INTEGER,
        remotePlatform VARCHAR(128),
        remoteDescriptor_id INTEGER constraint remote_experiment_id_fk references experiment_tmp(id));
    """))

    op.get_bind().execute(text("""
    insert into experiment_tmp(id, user_id, name, type, automated, test_cases, ues, slice, application, exclusive, parameters, scenario, reservation_time)
        select id, user_id, name, type, automated, test_cases, ues, slice, application, exclusive, parameters, scenario, reservation_time 
        from experiment;
    """))

    op.get_bind().execute(text("drop table experiment;"))

    op.get_bind().execute(text("alter table experiment_tmp rename to experiment;"))


def downgrade():
    pass
    # ### commands auto generated by Alembic - please adjust! ###
    #op.drop_constraint(None, 'experiment', type_='foreignkey')
    #op.drop_column('experiment', 'remotePlatform')
    #op.drop_column('experiment', 'remoteDescriptor_id')
    # ### end Alembic commands ###
